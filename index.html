<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f03535" />
  <title>Validar canje â€” Gerencia</title>
  <link rel="icon" type="image/png" sizes="32x32" href="manzanas.png" />
  <link rel="stylesheet" href="app.css" />

  <!-- Firebase (compat 10.x) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Tu configuraciÃ³n Firebase (debe ejecutar firebase.initializeApp({...})) -->
  <script src="firebase-config.js"></script>

  <!-- Lector QR: doble CDN y SIN defer para que cargue antes que app.js -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script>
    // Fallback por si unpkg falla
    if (typeof window.Html5Qrcode === "undefined") {
      var s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js";
      document.head.appendChild(s);
    }
  </script>

  <!-- Tu app (ya puede asumir que Html5Qrcode estÃ¡ cargado) -->
  <script src="app.js" defer></script>
</head>
<body class="bg">
  <header class="top">
    <div class="top__wrap">
      <h1 class="top__title">Validar canje <span class="pill">Gerencia</span></h1>
      <!-- sin UI de sesiÃ³n -->
    </div>
  </header>

  <main class="page">
    <div id="envWarning" class="warn" hidden></div>

    <section class="card">
      <div class="grid">
        <!-- Columna: EscÃ¡ner -->
        <aside class="pane">
          <h2 class="pane__title">Escanear QR</h2>

          <div class="row">
            <select id="cameraSelect" class="input"></select>
            <button id="btnStart" class="btn">Iniciar</button>
            <button id="btnStop" class="btn btn-soft">Detener</button>
          </div>

          <div id="reader" class="reader" aria-label="Visor de cÃ¡mara"></div>

          <div class="row">
            <label for="fileScan" class="btn btn-soft" role="button">ðŸ“· Desde imagen</label>
            <input id="fileScan" type="file" accept="image/*" hidden />
            <button id="btnTestCam" class="btn btn-soft">Probar cÃ¡mara</button>
            <span id="testCamMsg" class="muted"></span>
          </div>

          <details class="manual">
            <summary>Â¿Sin cÃ¡mara? Validar manual</summary>
            <label class="label" for="manualPayload">JSON del QR</label>
            <textarea id="manualPayload" class="input" placeholder='{"uid":"...","redemptionId":"..."}' spellcheck="false"></textarea>
            <button id="btnValidarManual" class="btn">Validar JSON</button>

            <div class="row two">
              <input id="uidInput" class="input" placeholder="UID" />
              <input id="ridInput" class="input" placeholder="Redemption ID" />
            </div>
            <button id="btnValidarPorIds" class="btn btn-soft">Validar por UID + ID</button>
          </details>
        </aside>

        <!-- Columna: Resultado -->
        <section class="pane">
          <h2 class="pane__title">Resultado</h2>

          <div id="statusBanner" class="banner banner-warn">Esperando escaneoâ€¦</div>

          <div class="kv">
            <div><strong>Cliente (uid)</strong></div><div id="r_uid" class="muted">â€”</div>
            <div><strong>Redemption ID</strong></div><div id="r_id" class="muted">â€”</div>
            <div><strong>Recompensa</strong></div><div id="r_reward" class="muted">â€”</div>
            <div><strong>Costo</strong></div><div id="r_cost" class="muted">â€”</div>
            <div><strong>Expira</strong></div><div id="r_exp" class="muted">â€”</div>
            <div><strong>Estatus</strong></div><div id="r_status" class="muted">â€”</div>
            <div><strong>Canjeado por</strong></div><div id="r_by" class="muted">â€”</div>
            <div><strong>Fecha canje</strong></div><div id="r_when" class="muted">â€”</div>
          </div>

          <div class="row">
            <button id="btnRedeem" class="btn" disabled>Marcar como canjeado</button>
            <button id="btnCopyId" class="btn btn-soft" disabled>Copiar ID</button>
          </div>

          <details>
            <summary>Detalles tÃ©cnicos</summary>
            <pre id="debugBox" class="debug"></pre>
          </details>
        </section>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="redeemModal" class="modal" aria-hidden="true">
    <div class="modal__card">
      <h3>Confirmar canje</h3>
      <p>Â¿Deseas marcar este cupÃ³n como <b>canjeado</b>? Esta acciÃ³n no se puede deshacer.</p>
      <div class="row end">
        <button id="btnCancelRedeem" class="btn btn-soft" type="button">Cancelar</button>
        <button id="btnConfirmRedeem" class="btn" type="button">SÃ­, canjear</button>
      </div>
      <button id="btnCloseModal" class="modal__close" aria-label="Cerrar">âœ•</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
